# 買得ナビ API設計書

このディレクトリには、買得ナビのAPI設計書（OpenAPI 3.0形式）が格納されています。

## ファイル構成

- `api-design-user.yaml` - ユーザー側API設計書
- `api-design-admin.yaml` - 管理者側API設計書

## API概要

### ユーザー側API (`api-design-user.yaml`)

ユーザー向けの機能を提供するAPIです。

#### 主な機能分類

1. **チラシ関連**
   - チラシ一覧取得・検索
   - チラシ詳細表示
   - おすすめチラシ取得
   - **AIレシピ提案** (Cloud Vision API + OpenAI API)

2. **コラム関連**
   - コラム一覧取得
   - コラム詳細表示
   - 新着コラム取得

3. **マイページ関連**
   - ユーザー情報管理
   - お気に入り店舗管理（CRUD）
   - 通知設定管理

4. **商品関連**
   - 商品検索
   - 商品詳細・価格推移表示
   - AI分析レポート

5. **店舗関連**
   - 店舗検索
   - 店舗詳細表示
   - 店舗のチラシ一覧

6. **認証**
   - ユーザーログイン/ログアウト
   - 新規登録

### 管理者側API (`api-design-admin.yaml`)

管理者向けの管理機能を提供するAPIです。

#### 権限体系

| 権限 | 説明 | アクセス範囲 |
|------|------|-------------|
| **システム管理者** (system_admin) | 全機能へのアクセス権限 | 全リソース |
| **企業管理者** (company_admin) | 自社の管理機能 | 自社の店舗・チラシ・アカウント |
| **店舗ユーザー** (store_user) | 自店舗の管理機能 | 自店舗のチラシ・自分のアカウント |

#### 主な機能分類

1. **コラム管理** (システム管理者のみ)
   - CRUD操作
   - 一括ステータス変更
   - 一括削除

2. **企業管理** (システム管理者のみ)
   - CRUD操作
   - 契約管理
   - 一括ステータス変更

3. **店舗管理** (システム管理者・企業管理者)
   - CRUD操作
   - 権限によるデータフィルタリング

4. **チラシ管理** (全ての役割)
   - CRUD操作
   - 画像アップロード対応
   - 権限によるデータフィルタリング

5. **アカウント管理** (全ての役割)
   - CRUD操作
   - 権限管理
   - 権限によるデータフィルタリング

6. **認証**
   - 管理者ログイン
   - ログイン中の管理者情報取得

## Swaggerでの表示方法

### オンラインエディタを使用

1. [Swagger Editor](https://editor.swagger.io/) にアクセス
2. 左側のエディタにYAMLファイルの内容を貼り付け
3. 右側にAPIドキュメントが表示されます

### VS Code拡張機能を使用

1. VS Codeに `Swagger Viewer` 拡張機能をインストール
2. YAMLファイルを開く
3. `Shift + Alt + P` でプレビューを表示

### ローカルでSwagger UIを起動

```bash
# Dockerを使用する場合
docker run -p 8080:8080 -e SWAGGER_JSON=/api/api-design-user.yaml \
  -v $(pwd):/api swaggerapi/swagger-ui

# ブラウザで http://localhost:8080 にアクセス
```

## 特記事項

### AIレシピ提案API (`POST /flyers/{flyerId}/recipe`)

このエンドポイントは以下の処理を行います：

1. **Cloud Vision API** でチラシ画像からテキスト抽出（OCR）
2. 抽出されたテキストから商品情報を解析
3. **OpenAI API** で商品に基づいたレシピを生成

**注意:** この処理には10〜30秒程度かかる場合があります。

### 権限によるデータフィルタリング

管理者側APIでは、ユーザーの権限に応じて自動的にデータがフィルタリングされます：

- **システム管理者**: すべてのデータにアクセス可能
- **企業管理者**: 自社（companyId）のデータのみアクセス可能
- **店舗ユーザー**: 自店舗（storeId）のデータのみアクセス可能

## 次のステップ

1. これらのYAMLファイルを確認
2. 必要に応じて修正・追加
3. APIの資産に移動
4. バックエンド実装時の参照として使用

## 変更履歴

- 2024-01-XX: 管理者ログアウトAPI削除
  - フロントエンドでトークン削除により対応
  - ステートレスなJWT認証のためサーバー側の処理不要

- 2024-01-XX: 初版作成
  - ユーザー側API設計
  - 管理者側API設計
  - 権限体系の定義
